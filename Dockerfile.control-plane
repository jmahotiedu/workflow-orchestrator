FROM node:22-alpine

WORKDIR /app

COPY package.json package-lock.json tsconfig.base.json ./
COPY shared/package.json shared/package.json
COPY shared/tsconfig.json shared/tsconfig.json
COPY control-plane/package.json control-plane/package.json
COPY control-plane/tsconfig.json control-plane/tsconfig.json

RUN npm ci

COPY shared shared
COPY control-plane control-plane

EXPOSE 8080

CMD ["sh", "-c", "npm run -w control-plane migrate && npm run -w control-plane start"]
